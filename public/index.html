<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kira: Immersive Stories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        [x-cloak] { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 平滑过渡动画 */
        .message-container {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        .message-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 平滑过渡动画 */
        .message-container {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        
        .message-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 固定对话框最大宽度，避免布局跳动 */
        .message-bubble {
            min-height: 40px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        /* 对话内容更新时的平滑过渡 */
        .message-text {
            transition: all 0.3s ease;
        }
        
        /* 打字指示器容器，固定高度避免布局跳动 */
        .typing-indicator-container {
            height: 40px;
            display: flex;
            align-items: flex-end;
        }
        
        /* 平滑滚动 */
        .scroll-smooth {
            scroll-behavior: smooth;
        }
        
        /* 骨架屏效果 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        </style>
</head>
<body class="bg-gray-50 h-screen w-full flex flex-col overflow-hidden text-gray-900" x-data="app()">
    
    <!-- View: Home (Novel List) -->
    <template x-if="view === 'home'">
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <h1 class="text-3xl font-black mb-6 mt-4">Kira Stories</h1>
            <template x-for="novel in novels" :key="novel.id">
                <div @click="loadNovel(novel.id)" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex gap-4 active:scale-95 transition-transform cursor-pointer">
                    <img :src="novel.cover" class="w-20 h-28 object-cover rounded-xl shadow-sm bg-gray-200">
                    <div class="flex-1 flex flex-col justify-center">
                        <h3 class="font-bold text-lg mb-1" x-text="novel.title"></h3>
                        <p class="text-xs text-gray-500 line-clamp-2 mb-2" x-text="novel.description"></p>
                        <div class="flex gap-2">
                            <template x-for="tag in novel.tags">
                                <span class="text-[10px] bg-gray-100 px-2 py-1 rounded-full text-gray-600" x-text="tag"></span>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
            <div x-show="novels.length === 0" class="text-center text-gray-400 mt-20">Loading library...</div>
        </div>
    </template>

    <!-- View: Reader -->
    <template x-if="view === 'reader'">
        <div class="flex-1 flex flex-col h-full bg-[#f2f2f2]">
            <!-- Header -->
            <header class="bg-white/90 backdrop-blur border-b border-gray-200 p-3 flex items-center justify-between sticky top-0 z-10 shadow-sm">
                <button @click="view = 'home'" class="p-2 -ml-2 text-gray-500 hover:bg-gray-100 rounded-full">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <div class="text-center">
                    <h2 class="font-bold text-sm" x-text="currentNovel?.title"></h2>
                    <p class="text-[10px] text-gray-500" x-text="currentChapter?.title || 'Loading...'"></p>
                </div>
                <div class="w-8"></div> <!-- Spacer -->
            </header>

            <!-- Chat Container -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar scroll-smooth">
                <template x-for="msg in messages" :key="msg.id">
                    <div class="message-container visible" :data-message-id="msg.id">
                        <!-- Narration -->
                        <template x-if="msg.type === 'narration'">
                            <div class="flex justify-center my-4">
                                <div class="bg-gray-200/50 text-gray-500 text-xs px-4 py-1 rounded-full message-bubble" x-text="msg.text"></div>
                            </div>
                        </template>
                        
                        <!-- Dialogue -->
                        <template x-if="msg.type === 'dialogue'">
                            <div :class="msg.isUser ? 'flex flex-row-reverse items-end gap-2' : 'flex items-end gap-2'">
                                <template x-if="!msg.isUser">
                                    <img :src="getAvatar(msg.speaker)" class="w-8 h-8 rounded-full bg-gray-300 object-cover shadow-sm mb-1 transition-opacity duration-300">
                                </template>
                                
                                <div class="flex flex-col gap-1 max-w-[75%]">
                                    <template x-if="!msg.isUser">
                                        <span class="text-[10px] text-gray-400 ml-1 transition-opacity duration-300" x-text="msg.speaker"></span>
                                    </template>
                                    <div :class="msg.isUser ? 'bg-blue-500 text-white rounded-2xl rounded-br-none px-4 py-2 shadow-md' : 'bg-white text-gray-800 rounded-2xl rounded-bl-none px-4 py-2 shadow-sm border border-gray-100'" 
                                         class="text-sm leading-relaxed message-bubble">
                                        <span class="message-text" x-text="msg.text"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                
                <!-- Typing Indicator -->
                <div x-show="isTyping" class="typing-indicator-container flex items-end gap-2 ml-1" x-transition>
                     <img :src="getAvatar(currentSpeaker)" class="w-8 h-8 rounded-full bg-gray-300 object-cover shadow-sm mb-1">
                     <div class="flex flex-col gap-1 max-w-[75%]">
                         <span class="text-[10px] text-gray-400 ml-1" x-text="currentSpeaker"></span>
                         <div class="bg-white text-gray-800 rounded-2xl rounded-bl-none px-4 py-2 shadow-sm border border-gray-100 text-sm">...</div>
                     </div>
                </div>

                <!-- Choices -->
                <div x-show="currentChoices.length > 0 && !isTyping" class="choices-container visible flex flex-col gap-2 mt-4 px-4 pb-8">
                    <template x-for="choice in currentChoices" :key="choice.id">
                        <button @click="handleChoice(choice)" class="w-full bg-white border border-blue-100 text-blue-600 font-medium py-3 rounded-xl shadow-sm active:scale-95 transition-all duration-200 hover:bg-blue-50">
                            <span x-text="choice.text"></span>
                        </button>
                    </template>
                </div>
                 <!-- Spacer for scroll -->
                 <div class="h-4"></div>
            </div>

            <!-- Input Area (Pseudo) -->
            <div class="bg-white border-t border-gray-100 p-3 pb-safe">
                <div class="bg-gray-100 rounded-full px-4 py-3 text-gray-400 text-sm flex items-center gap-2 cursor-not-allowed opacity-60">
                    <i data-lucide="message-square" class="w-4 h-4"></i>
                    <span x-text="currentChoices.length > 0 ? 'Choose an option to continue...' : 'Waiting for response...'"></span>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                view: 'home',
                novels: [],
                currentNovel: null,
                currentChapter: null,
                messages: [],
                isTyping: false,
                currentChoices: [],
                paragraphQueue: [],
                currentSpeaker: '',
                
                async init() {
                    try {
                        const res = await fetch('novels_list.json');
                        if (!res.ok) throw new Error('Failed to load library');
                        this.novels = await res.json();
                        lucide.createIcons();
                    } catch (e) {
                        console.error(e);
                        alert('Failed to initialize app. Check console.');
                    }
                },

                async loadNovel(id) {
                    try {
                        const res = await fetch(`novels/${id}.json`);
                        if (!res.ok) throw new Error('Failed to load novel');
                        this.currentNovel = await res.json();
                        this.startChapter(0);
                        this.view = 'reader';
                        this.$nextTick(() => lucide.createIcons());
                    } catch (e) {
                        console.error(e);
                        alert('Error loading novel data.');
                    }
                },

                startChapter(index) {
                    const chapter = this.currentNovel.chapters[index];
                    if (!chapter) return;
                    this.currentChapter = chapter;
                    this.messages = [];
                    // Flatten logic: assuming linear flow for simplicity in demo
                    // Start with first paragraph
                    const firstPara = chapter.paragraphs[0];
                    if (firstPara) this.processParagraph(firstPara);
                },

                processParagraph(para) {
                    this.paragraphQueue = [...(para.parts || [])];
                    if (para.choices) {
                        this.pendingChoices = para.choices;
                    } else {
                        this.pendingChoices = [];
                    }
                    this.processQueue();
                },

                processQueue() {
                    if (this.paragraphQueue.length === 0) {
                        // End of paragraph parts, show choices if any
                        if (this.pendingChoices.length > 0) {
                            this.currentChoices = this.pendingChoices;
                            // Trigger choices container animation
                            this.$nextTick(() => {
                                const choicesContainer = document.querySelector('.choices-container');
                                if (choicesContainer) {
                                    choicesContainer.classList.remove('visible');
                                    void choicesContainer.offsetWidth; // Trigger reflow
                                    choicesContainer.classList.add('visible');
                                }
                                this.scrollToBottom();
                            });
                        }
                        return;
                    }

                    const part = this.paragraphQueue.shift();
                    
                    // Only show typing indicator for dialogue, not for narration
                    if (part.type === 'dialogue') {
                        this.currentSpeaker = part.speaker;
                        this.isTyping = true;
                        this.scrollToBottom();
                    }

                    // Simulate typing delay based on text length
                    const delay = part.type === 'narration' ? 300 : Math.min(1500, Math.max(800, part.text.length * 30));
                    
                    setTimeout(() => {
                        this.isTyping = false;
                        
                        // Add new message
                        const newMessage = {
                            id: Date.now(),
                            type: part.type,
                            text: part.text,
                            speaker: part.speaker,
                            isUser: false // Narrative/NPC is never user for now
                        };
                        
                        // Add message to array
                        this.messages.push(newMessage);
                        
                        // Scroll to bottom without animation to avoid layout issues
                        this.$nextTick(() => {
                            const container = document.getElementById('chat-container');
                            if (container) {
                                container.scrollTop = container.scrollHeight;
                            }
                        });
                        
                        // Next part
                        setTimeout(() => this.processQueue(), 500);
                    }, delay);
                },

                handleChoice(choice) {
                    // Hide choices with animation
                    const choicesContainer = document.querySelector('.choices-container');
                    if (choicesContainer) {
                        choicesContainer.classList.remove('visible');
                    }
                    
                    // Add user message
                    const userMessage = {
                        id: Date.now(),
                        type: 'dialogue',
                        text: choice.text,
                        isUser: true
                    };
                    this.messages.push(userMessage);
                    
                    // Scroll to bottom without animation to avoid layout issues
                    this.$nextTick(() => {
                        const container = document.getElementById('chat-container');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });

                    // Find next paragraph
                    // For simplicity, take first nextParagraph
                    const nextId = choice.nextParagraphs[0];
                    const nextPara = this.findParagraph(nextId);
                    
                    if (nextPara) {
                        setTimeout(() => {
                            this.currentChoices = [];
                            this.processParagraph(nextPara);
                        }, 800);
                    } else {
                        console.warn('Next paragraph not found:', nextId);
                        this.currentChoices = [];
                    }
                },

                findParagraph(id) {
                    if (!this.currentChapter) return null;
                    const all = [...(this.currentChapter.paragraphs || []), ...(this.currentChapter.extendedParagraphs || [])];
                    return all.find(p => p.id === id);
                },

                getAvatar(name) {
                    const char = this.currentNovel?.characters.find(c => c.name === name);
                    return char?.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${name}`;
                },
                
                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = document.getElementById('chat-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    });
                }
            }))
        });
    </script>
</body>
</html>
